<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë Admin Dashboard 2025</title>
    
    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ê–¥–º–∏–Ω–∫–∏ */
        body {
            display: block; 
            overflow-y: auto;
            padding: 20px;
            background-color: #0a0e17; /* –§–∏–∫—Å –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ */
        }

        .admin-wrapper { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding-bottom: 50px;
        }

        .admin-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .actions-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: rgba(46, 213, 115, 0.15);
            color: #2ed573;
            border: 1px solid #2ed573;
        }
        .copy-btn:hover { background: #2ed573; color: #000; }

        .img-btn {
            background: rgba(251, 197, 49, 0.15);
            color: #fbc531;
            border: 1px solid #fbc531;
        }
        .img-btn:hover { background: #fbc531; color: #000; }

        .back-link { 
            color: #fbc531; 
            text-decoration: none; 
            font-weight: bold; 
            border: 1px solid #fbc531; 
            padding: 10px 20px; 
            border-radius: 50px; 
            transition: 0.3s;
        }
        .back-link:hover { background: #fbc531; color: #000; }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); 
            padding: 25px; 
            border-radius: 16px; 
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
        }
        .stat-val { font-size: 2.2rem; font-weight: 800; color: #fbc531; display: block; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: #a4b0be; text-transform: uppercase; letter-spacing: 1px; }

        /* –°–µ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ */
        .orders-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; 
            padding: 10px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ */
        }
        .order-card { 
            background: rgba(30, 39, 46, 0.85); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 16px; 
            padding: 20px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .guest-name { font-size: 1.3rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .order-time { font-size: 0.8rem; color: #7f8fa6; margin-bottom: 15px; display: block; }
        
        .order-list { 
            margin: 15px 0; 
            max-height: 250px; 
            overflow-y: auto; 
            padding-right: 5px;
        }
        .order-list::-webkit-scrollbar { width: 4px; }
        .order-list::-webkit-scrollbar-thumb { background: #57606f; border-radius: 4px; }

        .order-row { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.95rem; 
            margin-bottom: 8px; 
            border-bottom: 1px dashed rgba(255,255,255,0.1); 
            padding-bottom: 4px; 
        }
        .order-row span:first-child { color: #dfe6e9; margin-right: 10px; }
        .order-row span:last-child { color: #fbc531; font-weight: 600; white-space: nowrap; }
        
        .card-footer { 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 1px solid rgba(255,255,255,0.2); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .total-price { font-size: 1.4rem; font-weight: 800; color: #2ed573; text-shadow: 0 0 10px rgba(46, 213, 115, 0.3); }

        /* –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Å—Ç–µ–π –±–µ–∑ –∑–∞–∫–∞–∑–∞ */
        .missing-guests { 
            margin-top: 50px; 
            background: rgba(0,0,0,0.4); 
            padding: 30px; 
            border-radius: 20px; 
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        .missing-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .missing-tag { 
            background: rgba(255, 71, 87, 0.2); 
            color: #ff6b81; 
            border: 1px solid #ff4757;
            padding: 8px 16px; 
            border-radius: 50px; 
            font-size: 0.9rem; 
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .admin-header { flex-direction: column; gap: 15px; text-align: center; }
            .stat-val { font-size: 1.8rem; }
            .actions-bar { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <div class="admin-header">
            <div>
                <h1 style="margin:0; font-size: 1.8rem;">üëë –ü—É–ª—å—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                <span style="color:#a4b0be; font-size: 0.9rem;">–ù–æ–≤—ã–π –≥–æ–¥ 2025 ‚Ä¢ Realtime</span>
            </div>
            <a href="index.html" class="back-link">‚ùÆ –ù–∞–∑–∞–¥ –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫—É</a>
        </div>

        <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
        <div class="actions-bar">
            <button onclick="copyOrdersText()" class="action-btn copy-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º</button>
            <button onclick="downloadOrdersImage()" class="action-btn img-btn">üì∏ –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –∑–∞–∫–∞–∑–æ–≤</button>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <span class="stat-val" id="total-money">0 ‚ÇΩ</span>
                <span class="stat-label">üí∞ –û–±—â–∞—è –∫–∞—Å—Å–∞</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="orders-count">0 / 26</span>
                <span class="stat-label">üìä –°–¥–µ–ª–∞–ª–∏ –∑–∞–∫–∞–∑</span>
            </div>
        </div>

        <h3 style="margin-left: 10px;">üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
        <div class="orders-grid" id="orders-container">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #a4b0be; font-size: 1.1rem;">
                ‚è≥ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...
            </div>
        </div>

        <div class="missing-guests">
            <h3 style="color: #ff6b81;">üò¥ –ï—â—ë –Ω–µ –∑–∞–∫–∞–∑–∞–ª–∏:</h3>
            <div class="missing-list" id="missing-container"></div>
        </div>
    </div>

    <!-- –°–ö–†–ò–ü–¢ –ê–î–ú–ò–ù–ö–ò -->
    <script type="module">
        import { db } from './firebase-init.js';
        import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –∏–º–µ–ª–∏ –¥–æ—Å—Ç—É–ø)
        window.allOrdersData = [];

        const allGuests = [
            "–ê–π—Ä–∞–ø–µ—Ç—è–Ω—Ü –°–æ—Ñ–∏—è", "–ë–µ–±–∏—è –ë–∞–≥—Ä–∞—Ç", "–ë–µ–ª—è–µ–≤ –î–º–∏—Ç—Ä–∏–π", "–ë–æ–∂–µ—Å–∫–∏–π –ê—Ä—Ç—ë–º", "–ë—É–Ω–∫–æ–≤—Å–∫–∞—è –í–µ—Ä–æ–Ω–∏–∫–∞",
            "–í–∞–ª–µ–µ–≤–∞ –£–ª—å—è–Ω–∞", "–í–æ—Ä–æ–±–µ–ª—å –ï–ª–∏–∑–∞–≤–µ—Ç–∞", "–ì–∞—Ç–∏–∫–æ–µ–≤–∞ –ö–∞—Ä–∏–Ω–∞", "–ì–µ—Ä–∞—Å–∏–º–æ–≤–∞ –ü–æ–ª–∏–Ω–∞", "–ì–æ—Ä–ª–æ–≤ –ú–∞–∫—Å–∏–º",
            "–î–µ–º–∏–¥–æ–≤–∏—á –í–µ—Ä–æ–Ω–∏–∫–∞", "–î—Ä—ã–±–∞–ª–æ–≤ –ê–Ω–¥—Ä–µ–π", "–ï–ª—Å—É–∫–æ–≤–∞ –ö–∏—Ä–∞", "–ï—Ä–º—É—Ö–∞–Ω–æ–≤ –ñ–∞–Ω–∞—Ö–º–µ–¥", "–ö–∞–ª–∏–Ω–∏–Ω–∞ –õ–∏–∞–Ω–∞",
            "–ö–æ—á–º–∞—Ä –ï–≤–≥–µ–Ω–∏—è", "–õ–µ–æ–Ω—Ç—å–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞", "–ù–∞–¥—å—è—Ä–Ω–∞—è –ï–ª–∏–∑–∞–≤–µ—Ç–∞", "–û—á–∞–∫–æ–≤–∞ –ö—Å–µ–Ω–∏—è", "–ü—è–∂–∏–µ–≤–∞ –ê–ª–∏–Ω–∞",
            "–†–∞–¥–∏–≤–∏–ª–æ–≤ –ö–∏—Ä–∏–ª–ª", "–†—ã–±–∞–∫ –ì—Ä–∏–≥–æ—Ä–∏–π", "–®–∞—Ä–∏–Ω –ö–∏—Ä–∏–ª–ª", "–®–∏–ª–æ–≤–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞", "–Ø–Ω—Ü–µ–≤–∏—á –ü–æ–ª–∏–Ω–∞", "–ê–ª–±–∞–µ–≤–∞ –õ–∞—Ä–∏—Å–∞ –ö–∞–¥—ã—Ä–æ–≤–Ω–∞"
        ];

        const ordersContainer = document.getElementById('orders-container');
        const missingContainer = document.getElementById('missing-container');
        const totalMoneyEl = document.getElementById('total-money');
        const ordersCountEl = document.getElementById('orders-count');

        onSnapshot(collection(db, "orders"), (snapshot) => {
            ordersContainer.innerHTML = '';
            missingContainer.innerHTML = '';
            
            let globalTotal = 0;
            let orderedNames = [];
            let orders = [];

            snapshot.forEach((doc) => {
                orders.push(doc.data());
            });

            if (orders.length === 0) {
                ordersContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #a4b0be;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ ü§∑‚Äç‚ôÇÔ∏è</div>';
            }

            orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω–æ
            window.allOrdersData = orders;

            orders.forEach(data => {
                globalTotal += data.totalPrice;
                orderedNames.push(data.userName);
                
                const summary = {};
                data.items.forEach(i => summary[i.title] = (summary[i.title] || 0) + 1);

                let itemsHtml = '';
                for (const [name, count] of Object.entries(summary)) {
                    itemsHtml += `<div class="order-row"><span>${name}</span><span>x${count}</span></div>`;
                }

                const dateObj = new Date(data.timestamp);
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateStr = dateObj.toLocaleDateString();

                const card = document.createElement('div');
                card.className = 'order-card fade-in';
                card.innerHTML = `
                    <div class="guest-name">${data.userName}</div>
                    <span class="order-time">üïí ${timeStr} (${dateStr})</span>
                    <div class="order-list">${itemsHtml}</div>
                    <div class="card-footer">
                        <span style="color:#a4b0be">–ò—Ç–æ–≥–æ:</span>
                        <span class="total-price">${data.totalPrice} ‚ÇΩ</span>
                    </div>
                `;
                ordersContainer.appendChild(card);
            });

            totalMoneyEl.textContent = globalTotal.toLocaleString() + ' ‚ÇΩ';
            ordersCountEl.textContent = `${orderedNames.length} / ${allGuests.length}`;

            const missing = allGuests.filter(g => !orderedNames.includes(g));
            
            if (missing.length === 0) {
                missingContainer.innerHTML = '<span style="color:#2ed573; font-size: 1.2rem; font-weight:bold;">üî• –í—Å–µ –º–æ–ª–æ–¥—Ü—ã, –≤—Å–µ –∑–∞–∫–∞–∑–∞–ª–∏! üéâ</span>';
            } else {
                missing.forEach(name => {
                    const tag = document.createElement('span');
                    tag.className = 'missing-tag';
                    tag.textContent = name;
                    missingContainer.appendChild(tag);
                });
            }
        });

        // --- –§–£–ù–ö–¶–ò–ò –ö–ù–û–ü–û–ö ---

        // 1. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê
        window.copyOrdersText = function() {
            if (!window.allOrdersData || window.allOrdersData.length === 0) {
                alert("–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.");
                return;
            }

            let textReport = "üéÑ **–ó–ê–ö–ê–ó–´ –ù–ê –ù–û–í–´–ô –ì–û–î 2025** üéÑ\n\n";
            let grandTotal = 0;

            window.allOrdersData.forEach((order, index) => {
                grandTotal += order.totalPrice;
                textReport += `${index + 1}. üë§ ${order.userName} ‚Äî üí∞ ${order.totalPrice} ‚ÇΩ\n`;
                
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
                const summary = {};
                order.items.forEach(i => summary[i.title] = (summary[i.title] || 0) + 1);
                
                for (const [name, count] of Object.entries(summary)) {
                    textReport += `   - ${name} (x${count})\n`;
                }
                textReport += "\n";
            });

            textReport += `------------------------\n`;
            textReport += `üí∞ –û–ë–©–ê–Ø –°–£–ú–ú–ê: ${grandTotal.toLocaleString()} ‚ÇΩ`;

            navigator.clipboard.writeText(textReport).then(() => {
                const btn = document.querySelector('.copy-btn');
                const oldText = btn.innerHTML;
                btn.innerHTML = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
                setTimeout(() => btn.innerHTML = oldText, 2000);
            }).catch(err => {
                alert("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + err);
            });
        };

        // 2. –°–ö–ê–ß–ò–í–ê–ù–ò–ï –§–û–¢–û
        window.downloadOrdersImage = function() {
            const element = document.getElementById('orders-container');
            if(element.children.length === 0) {
                alert("–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —Ñ–æ—Ç–æ.");
                return;
            }
            
            const btn = document.querySelector('.img-btn');
            btn.innerHTML = "‚è≥ –°–æ–∑–¥–∞—é —Ñ–æ—Ç–æ...";

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É html2canvas
            html2canvas(element, {
                backgroundColor: "#0a0e17", // –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∫–∞–∫ —É body
                scale: 2 // –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Orders_NY2025_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                btn.innerHTML = "üì∏ –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –∑–∞–∫–∞–∑–æ–≤";
            });
        };
    </script>
</body>
</html>